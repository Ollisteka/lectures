### Орг. вопросы

- компы - универские;
- винда - 32 бита;

##### Как получать баллы

- домашки на неделю;
- задачи на практике;
- финальная задача.

##### Как сдавать задачи
- понимать, что происходит в коде.

##### С чем будем работать
- OS;
- BIOS;
- напрямую с устройствами I\O.

##### Как
- порты;
- выделенные системные структуры памяти.

###Программы-резиденты (TSR Terminate and State Residents)
**Программа-резидент** — висит в ОП, может быть вызвана каким-то определённым образом. 

> Все программы пишем для x86 в режиме реальной адресации под DOS.

Как обратиться к резидентной программе?

- через определённое прерывание

Написать резидента == написать блок, реализующий функционал + установщик. 

В итоговом COM файле первой командой будет JMP на начало установщика.

Программа:

```
model tiny 		;все сегменты кода, данных и стека являются одним сегментом

.code
ORG 100h 		;отсюда начинаются адреса нашей программы. До этого лежит PSP?
```

ORG: до этого адреса лежит PSP (program segment prefix - Префикс программного сегмента)

##### **Чем отличается .com от .exe?**

> [quora](https://www.quora.com/What-is-the-difference-between-com-and-exe-files), [SO](https://stackoverflow.com/questions/2115651/difference-between-com-exe-and-bat), [прям крутой сравнительный ответ](https://www.techyv.com/questions/difference-between-com-and-exe-formats/)	

COM файл — файл с **командами** для MS-DOS.

Для адресации используется два 16-битных регистра: которые указывают на какой-то сегмент в памяти и сдвиг внутри него.  Значение "сегментного" регистр устанавливается DOS'ом, а программа не может его менять. Поэтому **размер com-файла не может превышать 64кб**. Зато выполнять легко - загрузил в память, установил сегментный регистр, прыгнул - и поехали.

Содержимое загружается в память **как есть**. При этом в начале создаётся специальная структура - **PSP**, которая занимает 256 байт. Чтобы код программиста не наложился на PSP, его нужно загрузить со сдвигом. Соответственно,  входная точка для com файла должна располагаться **по адресу** `100h `. Для этого используется директива `ORG 100h`.

Остаток от 64кб идёт под стек.

EXE — это файл с **бинарными** данными. У него даже есть особенная сигнатура: строчка `MZ` в первых двух байтах. Во время исполнения **файл в памяти может измениться**, например, из-за динамической линковки. Для поддержки такого поведения в его заголовке содержится больше информации, чем в com файле. Также у exe-файла **нет ограничений по памяти** и на **стек** - занимай хоть всю ОП. Входная точка также может быть **любой**.

Кратко:

|                   | COM                 | EXE          |
| :---------------- | ------------------- | ------------ |
| Entry point       | 100h                | Любая        |
| Max size          | 64kb                | Любой        |
| Max stack size    | 64kb - program size | Любой        |
| Runtime changes   | No                  | Yes          |
| Special signature | No                  | Yes (MZ, ZM) |



При загрузке com файла DOS создаёт 3 вспомогательные структуры: машинный код (бинарник), PSP и DOS-environment

##### **Что такое и зачем нужен PSP?**

> [Ссылка на какую-то вики с примером из debug](https://en.wikibooks.org/wiki/First_steps_towards_system_programming_under_MS-DOS_7/Appendix#A.07-1_Program_Segment_Prefix)
>
> [Неплохая практика](http://asmforfun.blogspot.com/2009/05/eeeeee.html)

PSP ( Program Segment Prefix) всегда имеет размер 256 байт. Cодержит таблицы и поля данных, используемые системой в процессе выполнения программы. Чаще всего используется для получения доступа к аргументам командной строки. В 80h лежит длина аргументов, а в 82h - сама строка, заканчивающаяся на 0Dh (а не на $)

> todo: сделать нормальную таблицу

[ссылка на таблицу](https://studfiles.net/preview/1869264/page:16/)

![psp_table_1](.\images\psp_table_1.png)
![psp_table_2](.\images\psp_table_2.png)
![psp_table_3](.\images\psp_table_3.png)



##### **Что такое и зачем нужен DOS-environment?**

В этом блоке памяти в формате плоского файла хранится информация о переменных окружения. Сегментный адрес лежит в PSP по адресу `2C`



Что от нас ждут:

- находить в памяти эти блоки;

- обосновывать, что они относятся именно к нашей программе.

  > Во всех (*потому что model tiny*) сегментных регистрах лежит указатель на начало программы. Поэтому СS:0000 указывает на PSP, а СS:0100 — на начало нашего кода.

Что использовать?

- debug

  > Архив лежит в папке files. Распаковать в папку с DOS, запустить.
  >
  > `dump ` - дамп памяти

- [symdeb](http://koapp.narod.ru/tehlit/programmer/assembler/masm/a1p4.html)

- turbo debugger (td)

- peporez (тройной альт?)



**!**`tasm /m` – **m**ultiple passes - оптимизация прыжков. Бывают близкие, адрес занимает 2 байта, и дальние, на 3. Если пробежать программу несколько раз, то можно понять, где какие. А иначе по дефолту все прыжки будут длинными.



##### ДЗ №1

> Написать программу, которая может загрузить резидента одним из двух способов (параметр командной строки):
>
> - 31h (INT 21 -> 31) функция DOS
>
> - INT 27h
>
> Чем отличаются эти способы? Вызовам нужны разные аргументы.
>
> Как будет выглядеть готовый файл:
>
> - Блок резидента: hello.asm
> - Блок инсталляции: смотрим на то, что пришло из командной строки



Как посмотреть резидентов:

- mem
- F2



> Разобраться, как работает 25, 35, 49 функция DOS
>
> Потом посмотреть на ОП и найти свою программу